<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fluid Simulator & Flipbook Generator</title>
  <meta name="description" content="A web-based 2D fluid simulator with export capabilities for game assets (flipbooks, textures). Features multiple material presets and simulation modes.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <div id="instructions-modal" class="modal active">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2>Welcome to Fluid Simulator</h2>
          <button class="close-btn" id="close-instructions">&times;</button>
        </div>
        <div class="modal-body">
          <p class="intro-text">
            A professional-grade interactive fluid simulation tool designed for game developers and artists. 
            Simulate realistic liquids, generate assets, and export them directly to your game engine.
          </p>
          
          <div class="instruction-grid">
            <div class="instruction-item">
              <h3>üé® Simulation Modes</h3>
              <ul class="detailed-list">
                <li>
                  <strong>Wall Splatter:</strong> Simulates liquid hitting a vertical surface. The fluid drips down due to gravity, leaving streaks. Perfect for blood splatters, leaks, or rainy windows.
                </li>
                <li>
                  <strong>Floor Splatter:</strong> Simulates liquid hitting a horizontal surface. It spreads organically using a height-map based fluid simulation, creating realistic irregular puddles.
                </li>
                <li>
                  <strong>One Click Pool:</strong> A procedural tool for instantly generating complete, realistic pools. It fills a volume with depth variation (dark centers, transparent edges) ideal for decals.
                </li>
                <li>
                  <strong>Smart Expansion:</strong> An advanced mode where fluid flows intelligently to fill available space, respecting terrain roughness and permeability. Great for "oozing" effects.
                </li>
                <li>
                  <strong>Experimental (Grid Fluid):</strong> A cellular automata based simulation for testing new flow algorithms.
                </li>
              </ul>
            </div>
            
            <div class="instruction-item">
              <h3>‚úèÔ∏è Shape Masking</h3>
              <p>Restrict fluid to specific shapes to fit your game assets:</p>
              <ul>
                <li><strong>Draw Area:</strong> Use the brush tool to paint valid areas directly on the canvas.</li>
                <li><strong>Upload PNG:</strong> Upload a black and white mask. Fluid will only exist in the white areas.</li>
              </ul>
            </div>

            <div class="instruction-item">
              <h3>üõ†Ô∏è Controls & Inputs</h3>
              <ul>
                <li><strong>Left Click / Touch:</strong> Spawn fluid or paint mask shapes.</li>
                <li><strong>Middle Mouse / Space + Drag:</strong> Pan the infinite canvas.</li>
                <li><strong>Scroll Wheel:</strong> Zoom in and out.</li>
                <li><strong>Properties Panel:</strong> Press ‚öôÔ∏è to tweak viscosity, gravity, surface tension, and more.</li>
              </ul>
            </div>

            <div class="instruction-item">
              <h3>üíæ Export Pipeline</h3>
              <p>Generate production-ready assets:</p>
              <ul>
                <li><strong>Textures:</strong> Export high-res PNGs (up to 4096px). Includes <strong>Depth Maps</strong> and <strong>Normal Maps</strong>.</li>
                <li><strong>Flipbooks:</strong> "Record" your simulation. The tool replays your actions deterministically and renders them into a sprite sheet (flipbook) with frame blending. Perfect for animated blood pools or splashes.</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="start-btn" class="btn-primary">Start Creating</button>
        </div>
      </div>
    </div>

    <div id="canvas-container">
      <div id="canvas-wrapper">
        <canvas id="fluid-canvas"></canvas>
        <canvas id="overlay-canvas"></canvas>
        <div id="spawn-overlay"></div>
      </div>
    </div>
    
    <!-- Recording overlay removed -->
    
    <!-- SVG Filter for Fluid Effect -->
    <svg style="position: absolute; width: 0; height: 0; pointer-events: none;">
      <defs>
        <filter id="fluid-goo" color-interpolation-filters="sRGB">
          <!-- Sharper Blur for higher fidelity -->
          <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" />
          <!-- High contrast alpha thresholding for sharp liquid edges -->
          <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 25 -9" result="goo" />
          <!-- Enhanced Specular Highlights -->
          <feSpecularLighting in="blur" surfaceScale="5" specularConstant="1.8" specularExponent="40" lighting-color="#ffffff" result="specular">
            <fePointLight x="500" y="-1000" z="500" />
          </feSpecularLighting>
          <!-- Composite specular onto the liquid shape -->
          <feComposite in="specular" in2="goo" operator="in" result="specularOut" />
          <!-- Blend original color -->
          <feComposite in="SourceGraphic" in2="goo" operator="atop" result="diffuse" />
          <!-- Final blend -->
          <feBlend in="specularOut" in2="diffuse" mode="screen" />
        </filter>
        <!-- Depth Map Filter (Grayscale) -->
        <filter id="fluid-depth">
          <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur" />
          <feColorMatrix in="blur" mode="matrix" values="0 0 0 1 0  0 0 0 1 0  0 0 0 1 0  0 0 0 25 -9" />
        </filter>
      </defs>
    </svg>
    
    <div id="controls-panel">
      <div class="controls-header">
        <button id="toggle-controls" class="icon-btn">‚öôÔ∏è</button>
        <div class="header-actions">
          <button id="pause-btn" class="btn-secondary" style="min-width: 60px;">Pause</button>
          <button id="reset-btn" class="btn-secondary">Reset</button>
          <button id="export-btn" class="btn-primary">Export</button>
        </div>
      </div>
      
      <div id="controls-content" class="collapsed">
        <div class="control-section">
          <h3>Canvas</h3>
          <div class="control-group">
            <label>Dimensions</label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="canvas-width" value="1024" step="128">
              <span style="align-self: center;">x</span>
              <input type="number" id="canvas-height" value="1024" step="128">
            </div>
          </div>
          <div class="control-group">
             <button id="center-view-btn" class="btn-secondary" style="width: 100%;">Reset View / Fit</button>
          </div>
        </div>

        <div class="control-section">
          <h3>Simulation Mode</h3>
          <div class="mode-selector">
            <button class="mode-btn active" data-mode="wall">Wall Splatter</button>
            <button class="mode-btn" data-mode="floor">Floor Splatter</button>
            <button class="mode-btn" data-mode="one-click">One Click Pool</button>
            <button class="mode-btn" data-mode="smart">Smart Expansion</button>
            <button class="mode-btn" data-mode="experimental" style="grid-column: span 3; background: #222; border: 1px dashed #666;">Experimental (Grid Fluid)</button>
          </div>
          
          <div id="pool-shape-controls" class="hidden" style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
            <label style="margin-bottom: 8px; display: block;">Shape Constraint</label>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
               <button id="draw-shape-btn" class="btn-secondary" style="flex: 1; font-size: 12px;">‚úèÔ∏è Draw Area</button>
               <button id="upload-shape-btn" class="btn-secondary" style="flex: 1; font-size: 12px;">üìÇ Upload PNG</button>
               <button id="clear-shape-btn" class="btn-secondary" style="width: 40px;" title="Clear Shape">üóëÔ∏è</button>
               <input type="file" id="mask-upload" accept="image/png" style="display: none;">
            </div>
            <div style="font-size: 10px; color: #aaa; line-height: 1.2;">
              Draw a shape or upload a PNG mask, then click to fill it.
            </div>
          </div>

          <div class="control-group" style="margin-top: 12px;">
            <label>Spawn Type</label>
            <div class="mode-selector">
              <button class="spawn-mode-btn active" data-spawn="spray">Spray/Stream</button>
              <button class="spawn-mode-btn" data-spawn="drop">Single Drop</button>
            </div>
          </div>
        </div>

        <div class="control-section">
          <h3>Material</h3>
          <div class="control-group">
            <label>Preset</label>
            <select id="material-select">
              <option value="custom">Custom</option>
              <option value="water">Water</option>
              <option value="blood">Blood</option>
              <option value="oil">Oil</option>
              <option value="honey">Honey</option>
              <option value="slime">Slime</option>
              <option value="chocolate">Chocolate</option>
            </select>
          </div>
        </div>

        <div class="control-section">
          <h3>Fluid Properties</h3>
          <div class="control-group">
            <label>Viscosity</label>
            <input type="range" id="viscosity" min="0" max="100" value="20">
            <span class="value">20</span>
          </div>
          <div class="control-group">
            <label>Density</label>
            <input type="range" id="density" min="1" max="100" value="50">
            <span class="value">50</span>
          </div>
          <div class="control-group">
            <label>Gravity</label>
            <input type="range" id="gravity" min="0" max="200" value="100">
            <span class="value">100</span>
          </div>
          <div class="control-group">
            <label>Surface Tension</label>
            <input type="range" id="surface-tension" min="0" max="100" value="30">
            <span class="value">30</span>
          </div>
          <div class="control-group">
            <label>Turbulence</label>
            <input type="range" id="turbulence" min="0" max="100" value="0">
            <span class="value">0</span>
          </div>
          <div class="control-group">
            <label>Pool Shape Randomness</label>
            <input type="range" id="pooling-randomness" min="0" max="100" value="20">
            <span class="value">20</span>
          </div>
          <div class="control-group">
            <label style="justify-content: space-between;">
              <span>Lifetime</span>
              <span style="font-size: 10px; display: flex; align-items: center; gap: 4px;">
                 <input type="checkbox" id="infinite-lifetime" style="width: 14px; height: 14px;"> Infinite
              </span>
            </label>
            <input type="range" id="particle-lifetime" min="1" max="60" value="10">
            <span class="value">10s</span>
          </div>
          <div class="control-group">
            <label>Time Scale</label>
            <input type="range" id="time-scale" min="0" max="200" value="100">
            <span class="value">1.00x</span>
          </div>
          <div class="control-group">
            <label>Substeps</label>
            <input type="range" id="substeps" min="1" max="10" value="1">
            <span class="value">1</span>
          </div>
        </div>

        <div class="control-section">
          <h3>Spawn Settings</h3>
          <div class="control-group">
            <label>Spawn Rate</label>
            <input type="range" id="spawn-rate" min="1" max="100" value="30">
            <span class="value">30</span>
          </div>
          <div class="control-group">
            <label>Drop Height / Velocity</label>
            <input type="range" id="spawn-velocity" min="0" max="200" value="50">
            <span class="value">50</span>
          </div>
          <div class="control-group">
            <label>Spread Angle</label>
            <input type="range" id="spread-angle" min="0" max="180" value="30">
            <span class="value">30¬∞</span>
          </div>
          <div class="control-group">
            <label>Throw Direction</label>
            <div id="compass-container">
              <div id="compass-arrow"></div>
            </div>
            <input type="hidden" id="spawn-direction" value="0">
          </div>
          <div class="control-group">
            <label>Particle Size</label>
            <input type="range" id="particle-size" min="1" max="10" value="3">
            <span class="value">3</span>
          </div>
          <div class="control-group">
            <label>Size Variance</label>
            <input type="range" id="size-randomness" min="0" max="100" value="50">
            <span class="value">50%</span>
          </div>
        </div>

        <div class="control-section">
          <h3>Visual Settings</h3>
          <div class="control-group">
            <label>Color</label>
            <input type="color" id="fluid-color" value="#ff0000">
          </div>
          <div class="control-group">
            <label>Opacity</label>
            <input type="range" id="opacity" min="10" max="100" value="80">
            <span class="value">80%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="export-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Export Options</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="export-type-selector">
          <button class="export-type-btn active" data-type="texture">Single Texture</button>
          <button class="export-type-btn" data-type="flipbook">Flipbook</button>
        </div>

        <div id="texture-options" class="export-options">
          <div class="control-group">
            <label>Resolution</label>
            <select id="texture-resolution">
              <option value="512">512x512</option>
              <option value="1024" selected>1024x1024</option>
              <option value="2048">2048x2048</option>
              <option value="4096">4096x4096</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="export-depth">
              Include Depth Map
            </label>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="export-normal">
              Include Normal Map
            </label>
          </div>
        </div>

        <div id="flipbook-options" class="export-options hidden">
          <div class="control-group">
            <label>Frames</label>
            <input type="number" id="frame-count" min="4" max="64" value="16">
          </div>
          <div class="control-group">
            <label>Frame Resolution</label>
            <select id="flipbook-resolution">
              <option value="256">256x256</option>
              <option value="512" selected>512x512</option>
              <option value="1024">1024x1024</option>
            </select>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="frame-blending" checked>
              Enable Frame Blending
            </label>
          </div>
          <div class="control-group">
            <label>Blend Strength</label>
            <input type="range" id="blend-strength" min="0" max="100" value="50">
            <span class="value">50%</span>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="flipbook-depth">
              Include Depth Map
            </label>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="flipbook-normal">
              Include Normal Map
            </label>
          </div>
          <!-- Preview removed, replaced with Record workflow -->
          <div class="control-group" style="margin-top: 10px; font-size: 12px; color: #aaa; line-height: 1.4;">
            <p><strong>Note:</strong> Flipbooks will reconstruct your entire session (since last Reset) and fit it into the selected frame count.</p>
          </div>
        </div>

        <div class="progress-container hidden" id="export-progress">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <div class="progress-text">Exporting... 0%</div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-export" class="btn-secondary">Cancel</button>
        <button id="confirm-export" class="btn-primary">Export / Record</button>
      </div>
    </div>
  </div>

  <script type="module" src="main.js"></script>
</body>
</html>